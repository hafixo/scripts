#!/usr/bin/env ruby

$LOAD_PATH.unshift(File.join(__dir__, "lib"))

require "y2status"

def render_erb(template, bind)
  include ERB::Util
  include Y2status::Helpers

  file = File.join(__dir__, "views", template)
  renderer = ERB.new(File.read(file))
  renderer.filename = file
  renderer.result(bind)
end

###################################################################################################

# force processing the command line options, this might exit if e.g.
# an invalid options or the "--help" option is used
Y2status::Options.instance


jenkins_servers = [
  Y2status::JenkinsServer.new("External Jenkins", "https://ci.opensuse.org/view/Yast")
]

# OBS
obs_projects = ["YaST:Head", "YaST:SLE-15:GA", "YaST:SLE-12:SP4", "YaST:SLE-12:SP3" ].map do |p|
  Y2status::ObsProject.new(p)
end

if !Y2status::Options.instance.public_only
  # internal Jenkins status
  jenkins_servers << Y2status::JenkinsServer.new("Internal Jenkins", "https://ci.suse.de/view/YaST")

  # IBS
  obs_projects += ["Devel:YaST:CASP:4.0", "Devel:YaST:SLE-12-SP3", "Devel:YaST:SLE-12-SP4",
    "Devel:YaST:SLE-15", "Devel:YaST:Head"].map do |p|
      Y2status::ObsProject.new(p, "https://api.suse.de")
  end
end

docker_images = ["yastdevel/ruby", "yastdevel/cpp", "yastdevel/libstorage-ng", "libyui/devel"].map do |i|
  Y2status::DockerImage.new(i)
end

obs_partial = render_erb("_obs.html.erb", binding)
jenkins_partial = render_erb("_jenkins.html.erb", binding)
docker_partial = render_erb("_docker.html.erb", binding)

page = render_erb("index.html.erb", binding)

r = Y2status::ErbRenderer.new("layout.html.erb")
puts r.render(body: page)
